/**
 * T&Lã‚µãƒãƒ¼ãƒˆæ ªå¼ä¼šç¤¾ ç›¸è«‡å¯¾å¿œè¡¨ è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ”¹å–„ç‰ˆã€‘
 * ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ç”Ÿæˆã•ã‚Œã‚‹Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è¦‹ãŸç›®ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§æ•´å½¢ã—ã€Google Chatã«é€šçŸ¥ã—ã¾ã™ã€‚
 */

// â˜…â˜…â˜…ã€å…¨ä½“è¨­å®šã€‘â˜…â˜…â˜…
// è¨­å®šã¯ä»¥å‰ã®ã¾ã¾ã§ã™ã€‚å¤‰æ›´ã¯ä¸è¦ã§ã™ã€‚
const FOLDER_ID = "15bqmqBsS2CyS5qTXIZ2yeUYuJHaQusa4";
const SHEET_NAME = "ç›¸è«‡å¯¾å¿œè¡¨_ver3";
const LINK_COLUMN_HEADER = "ãƒ¡ãƒ¢";
const SORT_COLUMN_HEADER = "å¯¾å¿œæ—¥";

// â˜…â˜…â˜…ã€Google Chat é€£æºè¨­å®šã€‘â˜…â˜…â˜…
// Google Chatã‚¹ãƒšãƒ¼ã‚¹ã®Incoming Webhook URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
// ä¾‹: "https://chat.googleapis.com/v1/spaces/AAAA.../messages?key=AIza..."
// è¨­å®šã—ãªã„ï¼ˆ""ã®ã¾ã¾ã«ã™ã‚‹ï¼‰ã¨ã€Chatã¸ã®é€šçŸ¥ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚
const CHAT_WEBHOOK_URL = "https://chat.googleapis.com/v1/spaces/AAQAGG3CvEw/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=3clpmj2Zxva5srZOrl9Mej5cVAZgYD0qB2uidK8JywM"; // â† ã“ã“ã«Webhook URLã‚’è¨­å®šã—ã¦ãã ã•ã„
// â˜…â˜…â˜…ã€è¨­å®šã¯ã“ã“ã¾ã§ã€‘â˜…â˜…â˜…


// --- æ©Ÿèƒ½1ï¼šã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨èµ·å‹•æ™‚ã®è‡ªå‹•æ•´å½¢ ---
function onOpen() {
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
  SpreadsheetApp.getUi()
    .createMenu('ä¾¿åˆ©æ©Ÿèƒ½')
    .addItem('1è¡Œè¿½åŠ ', 'insert1Row')
    .addItem('3è¡Œè¿½åŠ ', 'insert3Rows')
    .addItem('5è¡Œè¿½åŠ ', 'insert5Rows')
    .addToUi();

  // ã€æ”¹å–„ã€‘èµ·å‹•æ™‚ã«ã€ŒGeminiã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€åˆ—ã®æŠ˜ã‚Šè¿”ã—è¨­å®šã‚’ã€Œåˆ‡ã‚Šè©°ã‚ã‚‹ã€ã«ã—ã¦ã€è¡ŒãŒç¸¦ã«åºƒãŒã‚‹ã®ã‚’é˜²ã
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) return;

    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const geminiColumnName = "Geminiã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹";
    const geminiColumnIndex = headers.indexOf(geminiColumnName) + 1;

    if (geminiColumnIndex > 0) {
      // åˆ—å…¨ä½“ã«é©ç”¨
      const columnRange = sheet.getRange(1, geminiColumnIndex, sheet.getMaxRows(), 1);
      // ç¾åœ¨ã®è¨­å®šã‚’ç¢ºèªã—ã€ç•°ãªã‚‹å ´åˆã®ã¿è¨­å®šã™ã‚‹ã“ã¨ã§ã€ç„¡é§„ãªæ›¸ãè¾¼ã¿ã‚’é¿ã‘ã‚‹
      if (columnRange.getWrapStrategy() !== SpreadsheetApp.WrapStrategy.CLIP) {
        columnRange.setWrapStrategy(SpreadsheetApp.WrapStrategy.CLIP);
      }
    }
  } catch (e) {
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒé–‹ã‘ãªã„ã€æ¨©é™ãŒãªã„ãªã©ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºãªã©ã¯ç¶šè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
    console.error("èµ·å‹•æ™‚ã®è‡ªå‹•æ•´å½¢å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.toString());
  }
}

function insert1Row() { insertRowsBelowHeader(1); }
function insert3Rows() { insertRowsBelowHeader(3); }
function insert5Rows() { insertRowsBelowHeader(5); }
function insertRowsBelowHeader(numberOfRows) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) return;
  sheet.insertRowsAfter(1, numberOfRows);
  const newRowsRange = sheet.getRange(2, 1, numberOfRows, sheet.getLastColumn());
  newRowsRange.setHorizontalAlignment("left").setVerticalAlignment("middle");
}


// --- æ©Ÿèƒ½2ï¼šãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®è‡ªå‹•å‡¦ç† ---
/**
 * Googleãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼ã§å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã§ã™ã€‚
 * @param {Object} e - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹æƒ…å ±ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
 */
function onFormSubmit(e) {
  try {
    if (!e || !e.namedValues) {
      console.error("ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return; 
    }
    const values = e.namedValues;

    for (const key in values) {
      values[key] = values[key].join(', ');
    }

    const dateValue = values["å¯¾å¿œæ—¥"] ? new Date(values["å¯¾å¿œæ—¥"]) : new Date();
    const formattedDate = `${dateValue.getFullYear()}-${('0' + (dateValue.getMonth() + 1)).slice(-2)}-${('0' + dateValue.getDate()).slice(-2)}`;
    
    const companyName = values["äº‹æ¥­è€…å"] || "åç§°æœªå…¥åŠ›";
    const docTitle = `${formattedDate}_${companyName}_ã€ç›¸è«‡è¨˜éŒ²ã€‘`;
    
    const newDoc = DocumentApp.create(docTitle);
    const body = newDoc.getBody();

    // --- ã“ã“ã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å½¢å‡¦ç† ---

    // 1. ã‚¹ã‚¿ã‚¤ãƒ«ã®å®šç¾©
    const headerStyle = {};
    headerStyle[DocumentApp.Attribute.BACKGROUND_COLOR] = '#F3F3F3'; // è–„ã„ã‚°ãƒ¬ãƒ¼
    headerStyle[DocumentApp.Attribute.BOLD] = true;

    // 2. ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã®è¿½åŠ 
    body.appendParagraph(`ã€ç›¸è«‡è¨˜éŒ²ã€‘${companyName}æ§˜`).setHeading(DocumentApp.ParagraphHeading.TITLE);
    body.appendParagraph(`å¯¾å¿œæ—¥: ${formattedDate}`).setHeading(DocumentApp.ParagraphHeading.SUBTITLE);
    body.appendHorizontalRule();

    // 3. ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ ¼ç´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¨ã€é•·æ–‡ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†ã‘ã‚‹
    const tableData = [];
    const longTextFields = [
      "äº‹æ¥­è€…ãŒè€ƒãˆã‚‹èª²é¡Œ (é¡•åœ¨ãƒ‹ãƒ¼ã‚º)",
      "æœ¬è³ªçš„ãªèª²é¡Œ(æ½œåœ¨ãƒ‹ãƒ¼ã‚º)",
      "å…·ä½“çš„ãªææ¡ˆå†…å®¹",
      "Geminiã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹",
      "æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
    ];
    const formItems = FormApp.openByUrl(SpreadsheetApp.getActiveSpreadsheet().getFormUrl()).getItems();
    
    formItems.forEach(item => {
      const title = item.getTitle();
      if (values[title] && longTextFields.indexOf(title) === -1) {
        tableData.push([title, values[title]]);
      }
    });

    // 4. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    if (tableData.length > 0) {
      const table = body.appendTable(tableData);
      for (let i = 0; i < table.getNumRows(); i++) {
        table.getRow(i).getCell(0).setAttributes(headerStyle); // 1åˆ—ç›®ï¼ˆé …ç›®åï¼‰ã«ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
      }
    }
    
    // 5. é•·æ–‡é …ç›®ã‚’æ›¸ãå‡ºã™
    longTextFields.forEach(title => {
      if (values[title]) {
        body.appendParagraph("").setSpacingBefore(12); // å°‘ã—ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç©ºã‘ã‚‹
        body.appendParagraph(title).setHeading(DocumentApp.ParagraphHeading.HEADING2);
        body.appendParagraph(values[title]);
      }
    });

    // 6. ãƒ•ãƒƒã‚¿ãƒ¼ã‚’è¿½åŠ 
    body.appendParagraph("").setSpacingBefore(18);
    body.appendHorizontalRule();
    const footer = body.appendParagraph("T&Lã‚µãƒãƒ¼ãƒˆæ ªå¼ä¼šç¤¾");
    footer.setAlignment(DocumentApp.HorizontalAlignment.RIGHT);
    
    // --- æ•´å½¢å‡¦ç†ã¯ã“ã“ã¾ã§ ---
    
    newDoc.saveAndClose();

    const docFile = DriveApp.getFileById(newDoc.getId());
    const targetFolder = DriveApp.getFolderById(FOLDER_ID);
    docFile.moveTo(targetFolder);
    
    try {
      docFile.setSharing(DriveApp.Access.DOMAIN, DriveApp.Permission.EDIT);
    } catch (error) {
      console.log("ãƒ‰ãƒ¡ã‚¤ãƒ³å…±æœ‰è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼è©³ç´°: " + error.toString());
    }

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) throw new Error(`ã‚·ãƒ¼ãƒˆã€Œ${SHEET_NAME}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const linkColumnIndex = headers.indexOf(LINK_COLUMN_HEADER) + 1;
    
    if (linkColumnIndex > 0) {
      const row = e.range.getRow();
      sheet.getRange(row, linkColumnIndex).setValue(newDoc.getUrl());
    } else {
      console.log(`åˆ—ã€Œ${LINK_COLUMN_HEADER}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
    }

    // ä¿ç•™ä¸­ã®ã™ã¹ã¦ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å¤‰æ›´ã‚’é©ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€moveRowsã®å®‰å®šæ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚
    SpreadsheetApp.flush(); 

    // ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚ˆã£ã¦è¿½åŠ ã•ã‚ŒãŸè¡Œã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç›´ä¸‹ï¼ˆ2è¡Œç›®ï¼‰ã«ç§»å‹•ã—ã¾ã™ã€‚
    // e.rangeã‚’ç›´æ¥ä½¿ã†ã®ã§ã¯ãªãã€è¡Œå…¨ä½“ã‚’æ˜ç¤ºçš„ã«å–å¾—ã—ç›´ã—ã¦ã‹ã‚‰ç§»å‹•ã—ã¾ã™ã€‚
    const sourceRange = sheet.getRange(e.range.getRow(), 1, e.range.getNumRows(), sheet.getLastColumn());
    sheet.moveRows(sourceRange, 2);

    // â˜…â˜…â˜…ã€æ–°è¦è¿½åŠ ã€‘Google Chatã¸ã®é€šçŸ¥å‡¦ç† â˜…â˜…â˜…
    if (CHAT_WEBHOOK_URL) {
      // ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¸»è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã—ã€Chatç”¨ã®ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
      const chatPayload = createChatCard(values, formattedDate, newDoc.getUrl());
      // Chatã«é€šçŸ¥ã‚’é€ä¿¡
      sendNotificationToChat(chatPayload);
    }
    // â˜…â˜…â˜…ã€æ–°è¦è¿½åŠ  ã“ã“ã¾ã§ã€‘â˜…â˜…â˜…

  } catch (error) {
    MailApp.sendEmail(Session.getEffectiveUser().getEmail(), 
                      "ã€GASã‚¨ãƒ©ãƒ¼é€šçŸ¥ã€‘ç›¸è«‡è¨˜éŒ²ã®è‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ", 
                      "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n" + error.toString() + "\n\nã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ: " + JSON.stringify(e));
  }
}

/**
 * Markdownå½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’Google Chatã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªHTMLã«å¤‰æ›ã—ã¾ã™ã€‚
 * @param {string} text - å¤‰æ›ã™ã‚‹Markdownãƒ†ã‚­ã‚¹ãƒˆã€‚
 * @return {string} å¤‰æ›å¾Œã®HTMLãƒ†ã‚­ã‚¹ãƒˆã€‚
 */
function formatMarkdownForChat(text) {
  if (!text) return "";
  return text
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // å¤ªå­— **text** -> <b>text</b>
    .replace(/\n/g, '<br/>');              // æ”¹è¡Œ -> <br/>
}

// --- æ©Ÿèƒ½3ï¼šæ¯æ—¥å®šæ™‚ã®è‡ªå‹•ä¸¦ã¹æ›¿ãˆ ---
function dailySortSheet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) return;
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const sortColumnIndex = headers.indexOf(SORT_COLUMN_HEADER) + 1;
  if (sortColumnIndex === 0) return;
  const headerRows = 1;
  if (sheet.getLastRow() <= headerRows) return;
  const dataRange = sheet.getRange(headerRows + 1, 1, sheet.getLastRow() - headerRows, sheet.getLastColumn());
  dataRange.sort({ column: sortColumnIndex, ascending: false });
}


// â˜…â˜…â˜…ã€æ–°è¦è¿½åŠ ã€‘Google Chat é€šçŸ¥é–¢é€£ã®é–¢æ•° â˜…â˜…â˜…
/**
 * Google Chatã«é€ä¿¡ã™ã‚‹ã‚«ãƒ¼ãƒ‰å½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚
 * @param {Object} formValues - ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ (e.namedValues)ã€‚
 * @param {string} formattedDate - æ•´å½¢æ¸ˆã¿ã®å¯¾å¿œæ—¥ã€‚
 * @param {string} docUrl - ç”Ÿæˆã•ã‚ŒãŸGoogleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®URLã€‚
 * @return {Object} Google Chat APIç”¨ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
 */
function createChatCard(formValues, formattedDate, docUrl) {
  const companyName = formValues["äº‹æ¥­è€…å"] || "åç§°æœªå…¥åŠ›";
  const staffName = formValues["ãƒ¡ã‚¤ãƒ³æ‹…å½“è€…"] || "æœªå…¥åŠ›";
  const consultationType = formValues["ææ¡ˆã‚µãƒ¼ãƒ“ã‚¹"] || "æœªå…¥åŠ›";
  const proposal = formatMarkdownForChat(formValues["å…·ä½“çš„ãªææ¡ˆå†…å®¹"] || "è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“"); // Markdownå¯¾å¿œ
  const geminiAdvice = formValues["Geminiã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹"] || "";

  // ä¼æ¥­åã‚’T&Lã‚µãƒãƒ¼ãƒˆã®ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ã«è¿‘ã„é’è‰²ã§å¼·èª¿
  const coloredCompanyName = `<font color="#00579B">${companyName}</font>`;
  
  // Geminiã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‹ã‚‰è¦ç´„ã‚’æŠ½å‡º
  let adviceSummary = "";
  if (geminiAdvice) {
    const summaryMatch = geminiAdvice.match(/### è¦ç´„\n([\s\S]*?)(\n###|$)/);
    if (summaryMatch && summaryMatch[1]) {
      adviceSummary = formatMarkdownForChat(summaryMatch[1].trim());
    } else {
      // è¦ç´„ãŒãªã„å ´åˆã¯ã€å…¨æ–‡ã®å†’é ­ã‚’åˆ‡ã‚Šå‡ºã—ã¦è¡¨ç¤º
      adviceSummary = formatMarkdownForChat(geminiAdvice.substring(0, 200) + (geminiAdvice.length > 200 ? "..." : ""));
    }
  }

  const card = {
    "header": {
      "title": "ğŸ“„ æ–°ç€ç›¸è«‡ãƒ¬ãƒãƒ¼ãƒˆãŒå±Šãã¾ã—ãŸï¼",
      "subtitle": `æ‹…å½“: ${staffName} ã•ã‚“`,
      // "imageUrl": "https://www.gstatic.com/images/icons/material/system/2x/post_add_black_48dp.png", // è¡¨ç¤ºã«å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€ã‚¿ã‚¤ãƒˆãƒ«çµµæ–‡å­—ã§ä»£æ›¿
      "imageType": "CIRCLE"
    },
    "sections": [
      {
        "header": `<b>${coloredCompanyName}æ§˜</b>ã¨ã®ã”ç›¸è«‡`,
        "widgets": [
          { "decoratedText": { "topLabel": "å¯¾å¿œæ—¥", "text": formattedDate, "startIcon": { "knownIcon": "CALENDAR" } } },
          { "decoratedText": { "topLabel": "ç›¸è«‡ç¨®åˆ¥", "text": consultationType, "startIcon": { "knownIcon": "STAR" } } }
        ]
      },
      {
        "header": "ææ¡ˆå†…å®¹ã®æ¦‚è¦",
        "collapsible": true,
        "widgets": [
          { "textParagraph": { "text": proposal } }
        ]
      }
    ]
  };

  // Geminiã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒã‚ã‚Œã°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
  if (adviceSummary) {
    card.sections.push({
      "header": "Geminiã‹ã‚‰ã®æˆ¦ç•¥çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ (è¦ç´„)",
      "collapsible": true,
      "widgets": [
        { "textParagraph": { "text": adviceSummary } }
      ]
    });
  }

  // æœ€å¾Œã«ãƒœã‚¿ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
  card.sections.push({
    "widgets": [{
      "buttonList": {
        "buttons": [{
          "text": "å…¨ã¦ã®è¨˜éŒ²ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è¦‹ã‚‹",
          "onClick": { "openLink": { "url": docUrl } },
          "icon": { "knownIcon": "DESCRIPTION" }
        }]
      }
    }]
  });

  return {
    "cardsV2": [{
      "cardId": "consultationCardWithGemini", // IDã‚’ã‚ˆã‚Šå…·ä½“çš„ã«
      "card": card
    }]
  };
}

/**
 * Google Chatã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã€‚
 * @param {Object} payload - é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã€‚
 */
function sendNotificationToChat(payload) {
  if (!CHAT_WEBHOOK_URL) {
    console.log("Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€Chatã¸ã®é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚");
    return;
  }
  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload)
  };
  try {
    UrlFetchApp.fetch(CHAT_WEBHOOK_URL, options);
  } catch (e) {
    console.error("Google Chatã¸ã®é€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.toString());
    // å¿…è¦ã«å¿œã˜ã¦ã€Chaté€šçŸ¥å¤±æ•—ã‚’ç®¡ç†è€…ã«ãƒ¡ãƒ¼ãƒ«ã§é€šçŸ¥ã™ã‚‹ãªã©ã®å‡¦ç†ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
  }
}
// â˜…â˜…â˜…ã€æ–°è¦è¿½åŠ  ã“ã“ã¾ã§ã€‘â˜…â˜…â˜…
