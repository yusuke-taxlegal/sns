// ã‚·ãƒ¼ãƒˆã®åå‰ã‚’å®šæ•°ã¨ã—ã¦å®šç¾©
const SPREADSHEET = SpreadsheetApp.getActiveSpreadsheet();
const LIST_SHEET_NAME = 'ğŸ‘¤ å‚åŠ è€…ãƒªã‚¹ãƒˆ';
const SETTINGS_SHEET_NAME = 'âš™ï¸ è¨­å®šãƒ»ãƒ¡ãƒ¼ãƒ«æ–‡é¢';
const LOG_SHEET_NAME = 'ğŸ“ é€ä¿¡ãƒ­ã‚°';

// åˆ—ã®ç•ªå·ã‚’å®šæ•°ã¨ã—ã¦å®šç¾©ï¼ˆAåˆ—ãŒ1, Båˆ—ãŒ2...ï¼‰
const CHECKBOX_COL = 1;      // é€ä¿¡ãƒã‚§ãƒƒã‚¯
const NAME_COL = 2;          // æ°å
const EMAIL_COL = 3;         // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
const GUIDE_STATUS_COL = 4;  // æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«çŠ¶æ³
const THANKS_STATUS_COL = 5; // ãŠç¤¼ãƒ¡ãƒ¼ãƒ«çŠ¶æ³

/**
 * ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ãŸã¨ãã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ã‚»ãƒŸãƒŠãƒ¼ç”¨ãƒ¡ãƒ¼ãƒ«é€ä¿¡')
    .addItem('é¸æŠã—ãŸäººã«æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡', 'sendGuideMail')
    .addSeparator()
    .addItem('é¸æŠã—ãŸäººã«ãŠç¤¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡', 'sendThanksMail')
    .addToUi();
}

/**
 * æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ãƒ¡ã‚¤ãƒ³ã®é–¢æ•°
 */
function sendGuideMail() {
  sendMail('guide');
}

/**
 * ãŠç¤¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ãƒ¡ã‚¤ãƒ³ã®é–¢æ•°
 */
function sendThanksMail() {
  sendMail('thanks');
}

/**
 * ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œã™ã‚‹å…±é€šé–¢æ•°
 * @param {string} mailType - 'guide' (æ¡ˆå†…) ã¾ãŸã¯ 'thanks' (ãŠç¤¼)
 */
function sendMail(mailType) {
  // è¨­å®šã‚·ãƒ¼ãƒˆã‹ã‚‰æƒ…å ±ã‚’å–å¾—
  const settings = getSettings();
  if (!settings) return; // è¨­å®šãŒãªã‘ã‚Œã°çµ‚äº†

  // ãƒªã‚¹ãƒˆã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸè¡Œã‚’å–å¾—
  const listSheet = SPREADSHEET.getSheetByName(LIST_SHEET_NAME);
  const dataRange = listSheet.getDataRange();
  const values = dataRange.getValues();
  const rowsToSend = [];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ1è¡Œç›®ï¼‰ã‚’é™¤ã„ã¦ãƒ«ãƒ¼ãƒ—
  for (let i = 1; i < values.length; i++) {
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒtrueã®è¡Œã‚’å¯¾è±¡
    if (values[i][CHECKBOX_COL - 1] === true) {
      rowsToSend.push({
        rowNum: i + 1, // ã‚·ãƒ¼ãƒˆä¸Šã®å®Ÿéš›ã®è¡Œç•ªå·
        name: values[i][NAME_COL - 1],
        email: values[i][EMAIL_COL - 1]
      });
    }
  }

  // é€ä¿¡ã™ã‚‹äººãŒã„ãªã‘ã‚Œã°çµ‚äº†
  if (rowsToSend.length === 0) {
    SpreadsheetApp.getUi().alert('é€ä¿¡å¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    return;
  }

  // é€ä¿¡ã®æœ€çµ‚ç¢ºèª
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'ç¢ºèª',
    `${rowsToSend.length}ä»¶ã®${mailType === 'guide' ? 'æ¡ˆå†…' : 'ãŠç¤¼'}ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`,
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return; // NOãŒæŠ¼ã•ã‚ŒãŸã‚‰çµ‚äº†
  }

  // ãƒ¡ãƒ¼ãƒ«ã®ä»¶åã¨æœ¬æ–‡ã‚’æ±ºå®š
  const subject = mailType === 'guide' ? settings.guideSubject : settings.thanksSubject;
  const bodyTemplate = mailType === 'guide' ? settings.guideBody : settings.thanksBody;
  const statusCol = mailType === 'guide' ? GUIDE_STATUS_COL : THANKS_STATUS_COL;

  // 1è¡Œãšã¤ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
  rowsToSend.forEach(person => {
    try {
      // æœ¬æ–‡ã®{{æ°å}}ã‚’ç½®æ›
      const body = bodyTemplate.replace('{{æ°å}}', person.name);
      
      // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
      GmailApp.sendEmail(person.email, subject, body);

      // é€ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      const timestamp = new Date();
      listSheet.getRange(person.rowNum, statusCol).setValue(`é€ä¿¡æ¸ˆã¿ (${Utilities.formatDate(timestamp, "JST", "yyyy/MM/dd HH:mm")})`);
      
      // ãƒ­ã‚°ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
      logSending('æˆåŠŸ', mailType, person.email, timestamp);
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’falseã«æˆ»ã™
      listSheet.getRange(person.rowNum, CHECKBOX_COL).setValue(false);

    } catch (e) {
      // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¨˜éŒ²
      logSending('å¤±æ•—', mailType, person.email, new Date(), e.message);
    }
  });
  
  ui.alert('é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
}

/**
 * è¨­å®šã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ¡ãƒ¼ãƒ«è¨­å®šã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * @returns {object|null} è¨­å®šæƒ…å ±ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function getSettings() {
  try {
    const settingsSheet = SPREADSHEET.getSheetByName(SETTINGS_SHEET_NAME);
    const settings = {
      seminarName: settingsSheet.getRange('B1').getValue(),
      dateTime: settingsSheet.getRange('B2').getValue(),
      zoomUrl: settingsSheet.getRange('B3').getValue(),
      guideSubject: settingsSheet.getRange('B4').getValue(),
      guideBody: settingsSheet.getRange('B5').getValue(),
      thanksSubject: settingsSheet.getRange('B6').getValue(),
      thanksBody: settingsSheet.getRange('B7').getValue()
    };
    return settings;
  } catch (e) {
    SpreadsheetApp.getUi().alert('ã€Œâš™ï¸ è¨­å®šãƒ»ãƒ¡ãƒ¼ãƒ«æ–‡é¢ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
    return null;
  }
}

/**
 * é€ä¿¡ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * @param {string} result - 'æˆåŠŸ' ã¾ãŸã¯ 'å¤±æ•—'
 * @param {string} mailType - 'guide' ã¾ãŸã¯ 'thanks'
 * @param {string} email - é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param {Date} timestamp - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
 * @param {string} [error=''] - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
function logSending(result, mailType, email, timestamp, error = '') {
  const logSheet = SPREADSHEET.getSheetByName(LOG_SHEET_NAME);
  logSheet.appendRow([
    timestamp,
    mailType === 'guide' ? 'æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«' : 'ãŠç¤¼ãƒ¡ãƒ¼ãƒ«',
    email,
    result,
    error
  ]);
}